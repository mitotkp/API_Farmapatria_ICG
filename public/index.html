<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Farmapatria ICG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .table-row-hover:hover td { background-color: #f8fafc; }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#0f172a', accent: '#3b82f6' } } }
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full">
        
        <nav class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shadow-sm z-30 shrink-0">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-blue-700 to-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-blue-200 shadow-lg">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 tracking-tight leading-none">Farmapatria ICG</h1>
                    <p class="text-xs text-slate-500 font-medium mt-1">Gestión de Integración SICM</p>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button @click="mostrarModalManual = true" class="bg-slate-50 text-slate-600 hover:bg-blue-50 hover:text-blue-600 border border-slate-200 transition-all px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm">
                    <i class="fas fa-keyboard text-xs"></i> <span>Entrada Manual</span>
                </button>
                <button @click="recargarDatos" class="text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-all p-2.5 rounded-lg active:scale-95">
                    <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
                </button>
            </div>
        </nav>

        <main class="flex-1 flex flex-col p-4 md:p-6 max-w-7xl mx-auto w-full overflow-hidden">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 shrink-0">
                <div class="flex p-1 bg-slate-200/60 rounded-xl gap-1 overflow-x-auto max-w-full">
                    <button v-for="tab in tabs" :key="tab.id"
                        @click="cambiarTab(tab.id)"
                        class="px-4 py-2 text-sm font-semibold rounded-lg transition-all whitespace-nowrap flex items-center gap-2"
                        :class="tabActual === tab.id ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'">
                        <i :class="tab.icon" :style="{ color: tabActual === tab.id ? tab.color : '' }"></i>
                        {{ tab.label }}
                    </button>
                </div>

                <div class="relative w-full md:w-72 group">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input v-model="filtro" @input="onSearchInput" type="text" 
                        :placeholder="tabActual === 'articulos' ? 'Buscar en servidor...' : 'Filtrar en esta página...'" 
                        class="w-full pl-10 pr-4 py-2.5 text-sm bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all shadow-sm">
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 flex-1 flex flex-col overflow-hidden animate-fade-in relative">
                
                <div v-if="loading && !itemsDetalle.length" class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-20 flex items-center justify-center">
                    <div class="flex flex-col items-center gap-3">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500"></i>
                        <span class="text-sm font-medium text-slate-500">Cargando datos...</span>
                    </div>
                </div>

                <div class="overflow-auto flex-1">
                    
                    <table v-if="['ventas', 'compras'].includes(tabActual)" class="w-full text-left text-sm border-collapse">
                        <thead class="bg-slate-50/80 backdrop-blur sticky top-0 z-10 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4 w-10"></th>
                                <th class="px-6 py-4">Fecha</th>
                                <th class="px-6 py-4">Documento</th>
                                <th class="px-6 py-4 text-center">Referencia</th>
                                <th class="px-6 py-4">{{ tabActual === 'ventas' ? 'Cliente' : 'Proveedor' }}</th>
                                <th class="px-6 py-4 text-right">Monto (Bs)</th>
                                <th class="px-6 py-4 text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <template v-for="item in listaFiltrada" :key="getKey(item)">
                                <tr @click="toggleDetalle(item)" class="table-row-hover transition-colors cursor-pointer group">
                                    <td class="px-6 py-3 text-center">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center transition-colors group-hover:bg-slate-200/50">
                                            <i class="fas fa-chevron-right text-xs text-slate-400 transition-transform duration-300" :class="expandedId === getKey(item) ? 'rotate-90 text-blue-500' : ''"></i>
                                        </div>
                                    </td>
                                    <td class="px-6 py-3 text-slate-500 whitespace-nowrap">{{ formatearFecha(item.fecha || item.FECHA || item.FECHAALBARAN) }}</td>
                                    <td class="px-6 py-3">
                                        <div class="flex items-center gap-2">
                                            <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-mono font-bold">{{ item.numSerie || item.NUMSERIE }}</span>
                                            <span class="font-medium text-slate-700">{{ item.numFactura || item.NUMFACTURA }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-3 text-center"><span class="text-xs text-slate-400">-</span></td>
                                    <td class="px-6 py-3">
                                        <div class="font-semibold text-slate-700">{{ getEntidad(item).nombre }}</div>
                                        <div class="text-xs text-slate-400 font-mono mt-0.5">{{ getEntidad(item).rif }}</div>
                                    </td>
                                    <td class="px-6 py-3 text-right font-mono font-medium text-slate-700">{{ formatearMoneda(item.totalNetoBs || item.TOTALNETO_BS) }}</td>
                                    <td class="px-6 py-3 text-center">
                                        <button v-if="tabActual === 'ventas'" @click.stop="prepararGuia(item)" 
                                            class="bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-blue-200 transition-all flex items-center justify-center mx-auto gap-2 shadow-sm hover:shadow">
                                            <i class="fas fa-paper-plane"></i> <span>Guía</span>
                                        </button>
                                        <span v-else class="text-[10px] uppercase font-bold text-slate-300 bg-slate-50 px-2 py-1 rounded">Solo Lectura</span>
                                    </td>
                                </tr>
                                <tr v-if="expandedId === getKey(item)">
                                    <td colspan="7" class="bg-slate-50/50 p-0 border-b border-slate-100">
                                        <div class="py-4 px-6 md:px-14">
                                            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                                <div v-if="cargandoDetalle" class="p-8 text-center text-slate-400 flex flex-col items-center gap-2">
                                                    <i class="fas fa-spinner fa-spin text-xl"></i> Cargando productos...
                                                </div>
                                                <table v-else class="w-full text-xs">
                                                    <thead class="bg-slate-50 text-slate-500 border-b border-slate-100">
                                                        <tr>
                                                            <th class="px-4 py-2 font-semibold text-left">Código</th>
                                                            <th class="px-4 py-2 font-semibold text-left">Descripción</th>
                                                            <th class="px-4 py-2 font-semibold text-right">Cant.</th>
                                                            <th class="px-4 py-2 font-semibold text-right">Precio</th>
                                                            <th class="px-4 py-2 font-semibold text-right">Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-slate-50">
                                                        <tr v-for="p in itemsDetalle" :key="p.codArticulo||p.CODARTICULO">
                                                            <td class="px-4 py-2 font-mono text-slate-500">{{ p.codArticulo||p.CODARTICULO }}</td>
                                                            <td class="px-4 py-2 text-slate-700">{{ p.descripcion||p.DESCRIPCION }}</td>
                                                            <td class="px-4 py-2 text-right font-bold text-slate-800">{{ Number(p.cantidad||p.CANTIDAD||0) }}</td>
                                                            <td class="px-4 py-2 text-right text-slate-600">{{ formatearMoneda(p.precioBs||p.PRECIOBS||0) }}</td>
                                                            <td class="px-4 py-2 text-right font-medium text-slate-800">{{ formatearMoneda((p.cantidad||0)*(p.precioBs||0)) }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <table v-if="['clientes', 'proveedores'].includes(tabActual)" class="w-full text-left text-sm border-collapse">
                        <thead class="bg-slate-50/80 backdrop-blur sticky top-0 z-10 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4">Código ICG</th>
                                <th class="px-6 py-4">Razón Social</th>
                                <th class="px-6 py-4">RIF / Documento</th>
                                <th class="px-6 py-4">Dirección</th>
                                <th class="px-6 py-4 text-center">Código SICM</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="c in listaFiltrada" :key="c.codCliente || c.codProveedor" class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-3 font-mono text-slate-400">{{ c.codCliente || c.codProveedor }}</td>
                                <td class="px-6 py-3 font-bold text-slate-700">{{ c.nombreCliente || c.razonSocial || c.nomProveedor }}</td>
                                <td class="px-6 py-3">
                                    <span class="bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded text-xs font-mono">{{ c.rifCliente || c.rifProveedor || c.rif }}</span>
                                </td>
                                <td class="px-6 py-3 text-xs text-slate-500 max-w-xs truncate" :title="c.direccion">{{ c.direccion || 'Sin dirección' }}</td>
                                <td class="px-6 py-3 text-center">
                                    <span v-if="c.codigoScim || c.CODSICM" class="inline-flex items-center gap-1.5 bg-green-50 text-green-700 px-2.5 py-1 rounded-full text-xs font-bold border border-green-100">
                                        <i class="fas fa-check-circle text-[10px]"></i> {{ c.codigoScim || c.CODSICM }}
                                    </span>
                                    <span v-else class="inline-flex items-center gap-1.5 bg-slate-100 text-slate-400 px-2.5 py-1 rounded-full text-xs font-medium border border-slate-200">
                                        <i class="fas fa-times-circle text-[10px]"></i> Sin Vincular
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <table v-if="tabActual === 'articulos'" class="w-full text-left text-sm border-collapse">
                        <thead class="bg-slate-50/80 backdrop-blur sticky top-0 z-10 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4">Código</th>
                                <th class="px-6 py-4">Ref. Prov.</th>
                                <th class="px-6 py-4">Descripción</th>
                                <th class="px-6 py-4">Cód. Barras</th>
                                <th class="px-6 py-4 text-center">Estado Mapeo</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="a in listaFiltrada" :key="a.CODARTICULO" class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-3 font-mono text-slate-500">{{ a.CODARTICULO }}</td>
                                <td class="px-6 py-3 text-xs text-slate-400 font-medium">{{ a.REFPROVEEDOR || '--' }}</td>
                                <td class="px-6 py-3 font-medium text-slate-700">{{ a.DESCRIPCION }}</td>
                                <td class="px-6 py-3 font-mono text-xs text-slate-500">{{ a.CODBARRAS }}</td>
                                <td class="px-6 py-3 text-center">
                                    <span v-if="a.codigoScim || a.CODSICM" class="inline-flex items-center gap-1.5 bg-teal-50 text-teal-700 px-2.5 py-1 rounded-full text-xs font-bold border border-teal-100">
                                        <i class="fas fa-link text-[10px]"></i> {{ a.codigoScim || a.CODSICM }}
                                    </span>
                                    <span v-else class="text-xs text-slate-300 italic">No mapeado</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                </div>

                <div v-if="!loading && listaFiltrada.length === 0" class="flex-1 flex flex-col items-center justify-center p-12 text-slate-400">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-search text-2xl text-slate-300"></i>
                    </div>
                    <p class="font-medium">No se encontraron registros</p>
                    <p class="text-xs mt-1">Intenta con otro término de búsqueda</p>
                </div>
            </div>

            <div v-if="listaFiltrada.length > 0 || pagina > 1" class="mt-4 flex items-center justify-between px-2 shrink-0">
                <div class="text-sm text-slate-500 font-medium">
                    Página <span class="text-slate-800 font-bold">{{ pagina }}</span> de <span class="text-slate-800 font-bold">{{ totalPaginas || 1 }}</span>
                </div>
                <div class="flex gap-2">
                    <button @click="cambiarPagina(-1)" :disabled="pagina <= 1 || loading" 
                        class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                        <i class="fas fa-chevron-left mr-1"></i> Anterior
                    </button>
                    <button @click="cambiarPagina(1)" :disabled="pagina >= totalPaginas || loading || listaFiltrada.length === 0" 
                        class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                        Siguiente <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>

        </main>

        <div v-if="mostrarModalManual" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity">
            <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-fade-in border border-white/20">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-slate-800">Generación Manual</h3>
                    <button @click="mostrarModalManual = false" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                </div>
                <form @submit.prevent="enviarManual" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Serie Factura</label>
                        <input v-model="formManual.serie" type="text" placeholder="Ej: A, B, AB3T" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none uppercase font-mono font-medium" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Número</label>
                        <input v-model="formManual.numero" type="number" placeholder="Ej: 12345" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none font-mono font-medium" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-500/30 active:scale-95">Generar Guía</button>
                </form>
            </div>
        </div>

        <div v-if="procesando" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50">
            <i class="fas fa-circle-notch fa-spin text-5xl text-blue-600 mb-4"></i>
            <h3 class="font-bold text-xl text-slate-800">Procesando solicitud...</h3>
            <p class="text-slate-500 text-sm mt-2">Por favor espera, no cierres esta ventana.</p>
        </div>

        <div v-if="resultado" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 px-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden animate-fade-in">
                <div :class="`p-6 text-center ${resultado.ok ? 'bg-green-50' : 'bg-red-50'}`">
                    <div :class="`mx-auto w-16 h-16 flex items-center justify-center rounded-full mb-4 ${resultado.ok ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`">
                        <i :class="`fas ${resultado.ok ? 'fa-check text-2xl' : 'fa-times text-2xl'}`"></i>
                    </div>
                    <h3 class="font-bold text-xl text-slate-900">{{ resultado.ok ? '¡Operación Exitosa!' : 'Ha ocurrido un error' }}</h3>
                </div>
                <div class="p-6">
                    <p class="text-slate-600 text-sm mb-6 text-center leading-relaxed">{{ resultado.msg }}</p>
                    <div v-if="resultado.ok && resultado.linkPDF">
                         <a :href="resultado.linkPDF" target="_blank" class="flex items-center justify-center w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/20 mb-3"><i class="fas fa-file-pdf mr-2"></i> Abrir Guía PDF</a>
                    </div>
                    <button @click="resultado = null" class="w-full py-3 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition">Cerrar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

        createApp({
            setup() {
                const tabs = [
                    { id: 'ventas', label: 'Ventas', icon: 'fas fa-shopping-cart', color: '#2563eb' },
                    { id: 'compras', label: 'Compras', icon: 'fas fa-truck-loading', color: '#9333ea' },
                    { id: 'clientes', label: 'Clientes', icon: 'fas fa-users', color: '#16a34a' },
                    { id: 'proveedores', label: 'Proveedores', icon: 'fas fa-industry', color: '#ea580c' },
                    { id: 'articulos', label: 'Artículos', icon: 'fas fa-boxes', color: '#0d9488' }
                ];

                const tabActual = ref('ventas');
                const datos = ref([]);
                const loading = ref(false);
                const filtro = ref('');
                const procesando = ref(false);
                const resultado = ref(null);
                const mostrarModalManual = ref(false);
                const formManual = reactive({ serie: '', numero: '' });
                const pagina = ref(1);
                const limite = ref(21);
                const totalPaginas = ref(1);
                const expandedId = ref(null);
                const itemsDetalle = ref([]);
                const cargandoDetalle = ref(false);
                let debounceTimer = null;

                const endpoints = {
                    ventas: '/api/facturas/obtenerFacturasVentas',
                    compras: '/api/facturas/obtenerFacturasCompras',
                    clientes: '/api/clientesProveedores/clientes',
                    proveedores: '/api/clientesProveedores/proveedores',
                    articulos: '/api/catalogo/articulos'
                };

                const cargarDatos = async () => {
                    loading.value = true;
                    expandedId.value = null;
                    try {
                        const url = new URL(endpoints[tabActual.value], window.location.origin);
                        url.searchParams.append('page', pagina.value);
                        url.searchParams.append('limit', limite.value);
                        
                        if (tabActual.value === 'articulos' && filtro.value) {
                            url.searchParams.append('q', filtro.value);
                        }

                        const res = await fetch(url);
                        if(!res.ok) throw new Error("Error en la petición");
                        const data = await res.json();
                        
                        let items = [];
                        if (tabActual.value === 'ventas' || tabActual.value === 'compras') items = data.facturas;
                        else if (tabActual.value === 'clientes') items = data.clientes;
                        else if (tabActual.value === 'proveedores') items = data.proveedores;
                        else if (tabActual.value === 'articulos') items = data.data || data.articulos;

                        // FIX: Detectar si la página está vacía pero el contador dice que hay más
                        if ((!items || items.length === 0) && pagina.value > 1) {
                            console.warn("Límite real alcanzado. Corrigiendo paginación...");
                            totalPaginas.value = pagina.value - 1; // Ajustamos el total real
                            pagina.value = totalPaginas.value;     // Regresamos a la última válida
                            await cargarDatos();                   // Recargamos
                            return; 
                        }

                        datos.value = items || [];
                        
                        // Solo actualizamos el total si NO hemos detectado el error de paginación
                        if (items.length > 0) {
                            // Si el backend manda mal el totalPages, usamos un máximo seguro si estamos cerca del final
                            totalPaginas.value = data.totalPages || 1;
                        }

                    } catch (e) {
                        console.error("Error:", e);
                        datos.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const cambiarTab = (nuevoTab) => {
                    tabActual.value = nuevoTab;
                    filtro.value = '';
                    pagina.value = 1;
                    datos.value = [];
                    cargarDatos();
                };

                const recargarDatos = () => cargarDatos();

                const cambiarPagina = (delta) => {
                    const nueva = pagina.value + delta;
                    if (nueva >= 1) {
                        pagina.value = nueva;
                        cargarDatos();
                    }
                };

                const onSearchInput = () => {
                    clearTimeout(debounceTimer);
                    if (tabActual.value === 'articulos') {
                        debounceTimer = setTimeout(() => { pagina.value = 1; cargarDatos(); }, 500);
                    }
                };

                const getKey = (item) => {
                    if (item.numSerie) return `${item.numSerie}-${item.numFactura}`;
                    if (item.NUMSERIE) return `${item.NUMSERIE}-${item.NUMFACTURA}`;
                    return Math.random().toString(36);
                };

                const toggleDetalle = async (item) => {
                    if (!['ventas', 'compras'].includes(tabActual.value)) return;
                    const uid = getKey(item);
                    if (expandedId.value === uid) { expandedId.value = null; return; }
                    expandedId.value = uid;
                    itemsDetalle.value = [];
                    cargandoDetalle.value = true;
                    try {
                        const endpoint = tabActual.value === 'ventas' ? '/api/facturas/buscarFacturaVenta' : '/api/facturas/buscarFacturaCompra';
                        const serie = item.numSerie || item.NUMSERIE;
                        const numero = item.numFactura || item.NUMFACTURA;
                        const res = await fetch(`${endpoint}?serie=${encodeURIComponent(serie)}&numero=${encodeURIComponent(numero)}`);
                        const data = await res.json();
                        let list = [];
                        if(data.factura && data.factura.items) list = data.factura.items;
                        else if(data.items) list = data.items;
                        else if(Array.isArray(data.factura)) list = data.factura;
                        else if(Array.isArray(data)) list = data;
                        itemsDetalle.value = list;
                    } catch (e) { console.error(e); } finally { cargandoDetalle.value = false; }
                };

                const getEntidad = (item) => {
                    if (item.cliente) return { nombre: item.cliente.razonSocial, rif: item.cliente.rifCliente };
                    if (item.proveedor) return { nombre: item.proveedor.razonSocial || item.proveedor.nombre, rif: item.proveedor.rif };
                    return { nombre: item.NOMBRECLIENTE || item.NOMPROVEEDOR || '---', rif: item.NIF20 || '' };
                };

                const formatearFecha = (f) => f ? new Date(f).toLocaleDateString('es-VE') : '-';
                const formatearMoneda = (v) => Number(v).toLocaleString('es-VE', { minimumFractionDigits: 2 });
                
                // --- FILTRADO LOCAL MEJORADO ---
                const listaFiltrada = computed(() => {
                    if (!filtro.value) return datos.value;
                    
                    // Artículos ya se filtra en servidor
                    if (tabActual.value === 'articulos') return datos.value;

                    const f = filtro.value.toLowerCase();
                    
                    return datos.value.filter(item => {
                        // Construimos un array con TODOS los valores posibles del item
                        let valores = [];

                        // 1. Campos comunes
                        if (item.codCliente) valores.push(String(item.codCliente));
                        if (item.codProveedor) valores.push(String(item.codProveedor));
                        if (item.nombreCliente) valores.push(item.nombreCliente);
                        if (item.razonSocial) valores.push(item.razonSocial);
                        if (item.nomProveedor) valores.push(item.nomProveedor);
                        if (item.rifCliente) valores.push(item.rifCliente);
                        if (item.rifProveedor) valores.push(item.rifProveedor);
                        if (item.rif) valores.push(item.rif);
                        if (item.direccion) valores.push(item.direccion);
                        if (item.codigoScim) valores.push(String(item.codigoScim));
                        if (item.CODSICM) valores.push(String(item.CODSICM));

                        // 2. Campos de facturas (Ventas/Compras)
                        if (item.NOMBRECLIENTE) valores.push(item.NOMBRECLIENTE);
                        if (item.NOMPROVEEDOR) valores.push(item.NOMPROVEEDOR);
                        if (item.NIF20) valores.push(item.NIF20);
                        if (item.NUMFACTURA) valores.push(String(item.NUMFACTURA));
                        if (item.numFactura) valores.push(String(item.numFactura));
                        if (item.CODCLIENTE) valores.push(String(item.CODCLIENTE));
                        if (item.CODPROVEEDOR) valores.push(String(item.CODPROVEEDOR));

                        // 3. Sub-objetos (si existen)
                        if (item.cliente) {
                            valores.push(item.cliente.razonSocial);
                            valores.push(item.cliente.rifCliente);
                        }
                        if (item.proveedor) {
                            valores.push(item.proveedor.razonSocial || item.proveedor.nombre);
                            valores.push(item.proveedor.rif);
                        }

                        // Convertimos todo a string minúsculas y buscamos coincidencia
                        return valores.some(val => val && String(val).toLowerCase().includes(f));
                    });
                });

                const prepararGuia = async (factura) => {
                    const serie = factura.numSerie || factura.NUMSERIE || factura.serie; 
                    const numero = factura.numFactura || factura.NUMFACTURA || factura.numero;
                    if(!confirm(`¿Generar guía para documento ${serie}-${numero}?`)) return;
                    const nuevaVentana = window.open('', '_blank');
                    if (nuevaVentana) {
                        nuevaVentana.document.write(`<html><head><title>Procesando...</title></head><body style="font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f8fafc;color:#334155"><div style="font-size:20px;font-weight:600;margin-bottom:10px">Conectando con SICM...</div><div>Por favor espere.</div></body></html>`);
                    } else {
                        alert("Habilita las ventanas emergentes (Popups) para ver la guía."); return;
                    }
                    procesando.value = true;
                    mostrarModalManual.value = false;
                    try {
                        const url = `/api/guia/generar?serie=${encodeURIComponent(serie)}&numero=${encodeURIComponent(numero)}`;
                        const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'} });
                        const data = await res.json();
                        if(!res.ok) throw new Error(data.msg || data.error || "Error desconocido");
                        if (data.link) {
                            nuevaVentana.location.href = data.link;
                            resultado.value = { ok: true, msg: "Guía generada correctamente.", linkPDF: data.link };
                        } else { throw new Error("No se recibió el enlace de la guía"); }
                    } catch(e) {
                        if (nuevaVentana) nuevaVentana.close();
                        resultado.value = { ok: false, msg: e.message };
                    } finally { procesando.value = false; }
                };

                const enviarManual = () => { prepararGuia({ serie: formManual.serie, numero: formManual.numero }); };

                onMounted(() => { cargarDatos(); });

                return {
                    tabs, tabActual, cambiarTab, cargarDatos, recargarDatos,
                    listaFiltrada, filtro, loading, procesando, resultado,
                    pagina, totalPaginas, cambiarPagina, onSearchInput,
                    toggleDetalle, expandedId, itemsDetalle, cargandoDetalle, getKey,
                    getEntidad, formatearFecha, formatearMoneda, prepararGuia,
                    mostrarModalManual, formManual, enviarManual
                };
            }
        }).mount('#app');
    </script>
</body>
</html>